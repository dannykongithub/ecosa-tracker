<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes" />
  <title>EcoSA Study Tracker</title>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif; }
    body { background: linear-gradient(135deg, #1a5f4b 0%, #2e8b57 100%); min-height: 100vh; padding: 15px; }

    .container {
      max-width: 520px;
      margin: 0 auto;
      background: white;
      border-radius: 24px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
      transition: all 0.3s ease;
    }

    /* Theme-specific styles */
    .container.competitive .stat-number { position: relative; color: #c4450c; }
    .container.competitive .habit-card:hover { border-color: #c4450c; transform: scale(0.98); }
    .container.duty .habit-card:hover { background: #e8f4f0; border-color: #004d40; }

    .header { background: linear-gradient(135deg, #004d40, #1e4d3b); color: white; padding: 22px 18px 18px; text-align: center; position: relative; }
    .flag-badge { position: absolute; top: 14px; right: 14px; background: #ffb300; color: #004d40; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 700; }
    .header h1 { font-size: 26px; margin-bottom: 6px; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .header p { opacity: 0.92; font-size: 14px; }
    .subline { margin-top: 8px; font-size: 12px; opacity: 0.9; }

    .progress-section { background: #f5f9f7; padding: 18px; border-bottom: 1px solid #d4e8dd; }
    .week-indicator { text-align: center; margin-bottom: 12px; }
    .week-badge { background: #004d40; color: white; padding: 8px 18px; border-radius: 30px; font-weight: 700; display: inline-block; font-size: 13px; }
    .progress-bar { height: 10px; background: #d4e8dd; border-radius: 10px; overflow: hidden; margin: 12px 0 14px; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, #004d40, #2e8b57); width: 0%; transition: width 0.3s ease; }

    .stats { display: flex; justify-content: space-around; text-align: center; background: white; padding: 14px 10px; border-radius: 16px; box-shadow: 0 4px 10px rgba(0,77,64,0.1); }
    .stat-item { flex: 1; }
    .stat-number { font-size: 24px; font-weight: 800; transition: color 0.3s ease; }
    .stat-label { font-size: 10px; color: #5e7a6b; text-transform: uppercase; letter-spacing: 0.6px; }

    .actions-section { padding: 18px; }
    .section-title { color: #004d40; font-size: 17px; margin-bottom: 12px; font-weight: 700; display: flex; align-items: center; gap: 8px; }

    .tips-card { background: #e8f4f0; padding: 14px; border-radius: 16px; margin-bottom: 12px; border-left: 4px solid #004d40; }
    .tips-card p { color: #004d40; font-size: 13px; }
    .rule-text { margin-top: 8px; font-size: 12px; color: #004d40; opacity: 0.85; }
    .reset-note { margin-top: 4px; font-size: 11px; color: #5e7a6b; font-style: italic; }

    .context-pill { display: inline-flex; align-items: center; gap: 8px; padding: 7px 12px; border-radius: 999px; font-weight: 800; font-size: 12px; margin-bottom: 10px; }
    .context-competitive { background: rgba(255,179,0,0.18); color: #7a4d00; border: 1px solid rgba(255,179,0,0.35); }
    .context-duty { background: rgba(0,77,64,0.12); color: #004d40; border: 1px solid rgba(0,77,64,0.22); }

    .context-panel {
      margin-top: 10px;
      background: white;
      border: 1px solid #d4e8dd;
      border-radius: 14px;
      padding: 12px;
      box-shadow: 0 2px 10px rgba(0,77,64,0.06);
      transition: all 0.3s ease;
    }
    .context-panel-title { font-size: 12px; font-weight: 900; letter-spacing: 0.5px; color: #004d40; opacity: 0.85; }
    .context-panel-value { font-size: 20px; font-weight: 900; color: #004d40; margin-top: 6px; transition: all 0.3s ease; }
    .context-panel-sub { font-size: 12px; color: #5e7a6b; margin-top: 4px; }

    .habit-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 14px; }
    .habit-card {
      background: #f5f9f7;
      border-radius: 16px;
      padding: 14px 10px 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 2px solid transparent;
      box-shadow: 0 2px 6px rgba(0,77,64,0.1);
      position: relative;
    }
    .habit-card.selected {
      background: #e0f2e9;
      border-color: #004d40;
      transform: scale(0.99);
      box-shadow: 0 4px 12px rgba(0,77,64,0.2);
    }
    .habit-emoji { font-size: 26px; margin-bottom: 8px; }
    .habit-name { font-size: 12px; font-weight: 800; color: #004d40; line-height: 1.25; min-height: 36px; }
    .habit-category { font-size: 10px; font-weight: 900; letter-spacing: 0.6px; margin-top: 7px; opacity: 0.65; color: #004d40; }

    .log-button {
      background: #004d40;
      color: white;
      border: none;
      width: 100%;
      padding: 16px;
      border-radius: 16px;
      font-size: 15px;
      font-weight: 900;
      cursor: pointer;
      transition: transform 0.15s ease, opacity 0.2s ease, background 0.3s ease;
      box-shadow: 0 4px 12px rgba(0,77,64,0.3);
    }
    .log-button:disabled { opacity: 0.55; cursor: not-allowed; box-shadow: none; }
    .log-button:active:not(:disabled) { transform: scale(0.99); }
    .container.competitive .log-button { background: #c4450c; }
    .container.competitive .log-button:hover { background: #a3380a; }

    .history-section { padding: 18px; background: #f5f9f7; border-top: 1px solid #d4e8dd; }
    .history-item { display: flex; align-items: center; padding: 12px; background: white; border-radius: 14px; margin-bottom: 10px; box-shadow: 0 2px 8px rgba(0,77,64,0.05); border: 1px solid #e0f2e9; }
    .history-emoji { font-size: 22px; margin-right: 12px; width: 44px; height: 44px; background: #f5f9f7; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
    .history-details { flex: 1; }
    .history-name { font-weight: 900; color: #004d40; font-size: 13px; }
    .history-time { font-size: 11px; color: #5e7a6b; margin-top: 4px; }
    .history-tag { font-size: 10px; font-weight: 900; letter-spacing: 0.6px; color: #004d40; opacity: 0.6; margin-top: 4px; }
    .empty-state { text-align: center; padding: 24px 14px; color: #5e7a6b; background: white; border-radius: 16px; font-size: 13px; }
    .footer-note { text-align: center; padding: 14px; background: #f5f9f7; font-size: 11px; color: #5e7a6b; border-top: 1px solid #d4e8dd; }

    .notification {
      position: fixed;
      bottom: 18px;
      left: 18px;
      right: 18px;
      max-width: 520px;
      margin: 0 auto;
      background: #004d40;
      color: white;
      padding: 14px;
      border-radius: 16px;
      text-align: center;
      display: none;
      z-index: 1000;
      font-weight: 900;
      box-shadow: 0 6px 20px rgba(0,0,0,0.2);
      animation: slideUp 0.3s ease;
    }
    .notification.competitive { background: #c4450c; }
    .notification.duty { background: #004d40; }

    .habit-card:focus { outline: 2px solid rgba(0,77,64,0.5); outline-offset: 2px; }

    @keyframes slideUp {
      from { transform: translateY(100px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
  </style>
</head>

<body>
  <div class="container" id="mainContainer">
    <div class="header">
      <div class="flag-badge">üáøüá¶ EcoSA</div>
      <h1>üåç EcoSA <span style="font-size: 14px; opacity: 0.9;">Study Tracker</span></h1>
      <p>Daily sustainable consumption logging (8 weeks)</p>
      <div class="subline" id="pidLine">Participant: ‚Äî</div>
    </div>

    <div class="progress-section">
      <div class="week-indicator">
        <span class="week-badge" id="weekDisplay">Week ‚Äî of 8</span>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
      </div>
      <div class="stats">
        <div class="stat-item">
          <div class="stat-number" id="totalLogs">0</div>
          <div class="stat-label">Total Logs</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="activeDays">0</div>
          <div class="stat-label">Active Days</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="streakDays">0</div>
          <div class="stat-label">Streak</div>
        </div>
      </div>
    </div>

    <div class="actions-section">
      <div class="section-title"><span>üå±</span> Today‚Äôs Actions</div>

      <div class="tips-card" id="tipsCard">
        <div id="contextPill" class="context-pill" style="display:none;"></div>
        <p id="contextText">Loading study context‚Ä¶</p>

        <div class="context-panel" id="contextPanel" style="display:none;">
          <div class="context-panel-title" id="panelTitle">‚Äî</div>
          <div class="context-panel-value" id="panelValue">‚Äî</div>
          <div class="context-panel-sub" id="panelSub">‚Äî</div>
        </div>

        <div class="rule-text">
          Rule: You may log up to one action in each category per day (PURCHASE, CIRCULARITY, RESOURCE).
          If you completed multiple actions within a category, log only the most effortful one.
        </div>
        <div class="reset-note">‚è∞ Logging resets at midnight local time.</div>
      </div>

      <div class="habit-grid" id="habitGrid"></div>
      <button class="log-button" id="logButton" disabled>‚úì Log Selected Action</button>
    </div>

    <div class="history-section">
      <div class="section-title"><span>üìä</span> Recent Logs</div>
      <div id="historyList">
        <div class="empty-state">No logs yet. Select an action you completed today and log it.</div>
      </div>
    </div>

    <div class="footer-note">
      Study mode: no reset, no sharing, no local editing. Records are create-only and stored securely.
    </div>
  </div>

  <div class="notification" id="notification"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFirestore,
      doc, getDoc, setDoc,
      collection, query, orderBy, limit, getDocs,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // =========================
    // 1) FIREBASE CONFIG
    // =========================
    const firebaseConfig = {
      apiKey: "AIzaSyCNCfnvq8R8ImxVzxZkNZss8grgfkZE-l8",
      authDomain: "ecosa-study.firebaseapp.com",
      projectId: "ecosa-study",
      storageBucket: "ecosa-study.firebasestorage.app",
      messagingSenderId: "533863345637",
      appId: "1:533863345637:web:bd72377d2b1cb60038930c",
      measurementId: "G-8S3ZSMM29V"
    };

    // =========================
    // 2) HABITS
    // =========================
    const habits = [
      // Purchase-stage
      { id: 1, name: "Refused Products with Excessive Packaging", emoji: "üì¶‚ùå", category: "purchase" },
      { id: 2, name: "Avoided Unnecessary Purchases", emoji: "üí≠üö´", category: "purchase" },
      { id: 3, name: "Used Reusable Shopping Bags", emoji: "üõçÔ∏è", category: "purchase" },
      { id: 9, name: "Chose a More Environmentally Sustainable Option in a Public Setting", emoji: "üå±üè™", category: "purchase" },

      // Circularity
      { id: 4, name: "Donated or Gave Away Unused Items", emoji: "üéÅ", category: "circularity" },
      { id: 5, name: "Separated Glass, Plastic, and Paper for Recycling", emoji: "‚ôªÔ∏è", category: "circularity" },
      { id: 8, name: "Repaired Broken Items Instead of Buying New", emoji: "üîß", category: "circularity" },

      // Resource
      { id: 6, name: "Reduced Water Usage", emoji: "üíß", category: "resource" },
      { id: 7, name: "Switched Off Geyser When Not Needed", emoji: "‚ö°", category: "resource" }
    ];

    // =========================
    // 3) STATE
    // =========================
    const Study = { pid: null, uid: null, condition: null, totalLogs: 0, createdAtDate: null };
    let selectedHabitId = null;

    // =========================
    // 4) HELPERS
    // =========================
    function getParam(name) {
      const u = new URL(window.location.href);
      return u.searchParams.get(name);
    }

    function localDayKey(d = new Date()) {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }

    function computeWeekFromServerCreatedAt(createdAtDate) {
      const start = createdAtDate;
      const now = new Date();
      const ms = now - start;
      const days = Math.floor(ms / (1000 * 60 * 60 * 24));
      return Math.min(8, Math.max(1, Math.floor(days / 7) + 1));
    }

    function showNotification(message, type = "ok", contextClass = "") {
      const el = document.getElementById("notification");
      el.textContent = message;
      el.style.background = (type === "warn") ? "#856404" : (type === "err") ? "#7f1d1d" : "#004d40";
      el.className = `notification ${contextClass || ""}`;
      el.style.display = "block";
      setTimeout(() => { el.style.display = "none"; }, 3200);
    }

    function prettyCategory(cat) {
      if (cat === "purchase") return "PURCHASE";
      if (cat === "circularity") return "CIRCULARITY";
      if (cat === "resource") return "RESOURCE";
      return String(cat || "").toUpperCase();
    }

    function getContextualMessage(condition) {
      if (condition === "competitive") {
        const messages = [
          "üèÜ Meeting high standards today.",
          "üèÜ Strive for excellence across categories.",
          "üèÜ Aim for your personal best.",
          "üèÜ Every action reflects your standards."
        ];
        return messages[Math.floor(Math.random() * messages.length)];
      } else {
        const messages = [
          "ü§ù Doing your part matters.",
          "ü§ù Your actions contribute to the community.",
          "ü§ù Responsibility shown today.",
          "ü§ù Thank you for participating."
        ];
        return messages[Math.floor(Math.random() * messages.length)];
      }
    }

    // =========================
    // 5) FIREBASE INIT
    // =========================
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // =========================
    // 6) RENDER HABITS
    // =========================
    function renderHabits() {
      const grid = document.getElementById("habitGrid");
      grid.innerHTML = "";

      habits.forEach(habit => {
        const card = document.createElement("div");
        card.tabIndex = 0;
        card.className = `habit-card ${selectedHabitId === habit.id ? "selected" : ""}`;
        card.innerHTML = `
          <div class="habit-emoji">${habit.emoji}</div>
          <div class="habit-name">${habit.name}</div>
          <div class="habit-category">${prettyCategory(habit.category)}</div>
        `;
        const select = () => {
          selectedHabitId = habit.id;
          document.getElementById("logButton").disabled = false;
          renderHabits();
        };
        card.addEventListener("click", select);
        card.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            select();
          }
        });
        grid.appendChild(card);
      });
    }

    // =========================
    // 7) SELF-BASED CONTEXT PANEL (NEUTRAL LANGUAGE)
    // =========================
    function computeCategoryCoverageForToday(allLogs) {
      const today = localDayKey(new Date());
      const cats = new Set(allLogs.filter(x => x.dayKey === today).map(x => x.category));
      return cats.size; // 0..3
    }

    function computeThisWeekCount(allLogs, createdAtDate) {
      const start = createdAtDate;
      const now = new Date();
      const daysSince = Math.floor((now - start) / (1000 * 60 * 60 * 24));
      const weekStartOffset = Math.floor(daysSince / 7) * 7;

      const weekStart = new Date(start);
      weekStart.setHours(0,0,0,0);
      weekStart.setDate(weekStart.getDate() + weekStartOffset);

      return allLogs.filter(x => {
        if (!x.dayKey) return false;
        const d = new Date(x.dayKey + "T00:00:00");
        return d >= weekStart && d <= now;
      }).length;
    }

    async function updateContextPanelFromSelf(allLogs) {
      const panel = document.getElementById("contextPanel");
      const panelTitle = document.getElementById("panelTitle");
      const panelValue = document.getElementById("panelValue");
      const panelSub = document.getElementById("panelSub");
      const mainContainer = document.getElementById("mainContainer");

      panel.style.display = "block";

      const coverageToday = computeCategoryCoverageForToday(allLogs); // 0..3
      const createdAtDate = Study.createdAtDate || new Date();
      const weeklyCount = computeThisWeekCount(allLogs, createdAtDate);

      if (Study.condition === "competitive") {
        mainContainer.classList.add("competitive");
        mainContainer.classList.remove("duty");
        panelTitle.textContent = "üèÜ HIGH STANDARDS (PERSONAL)";
        panelValue.textContent = `Categories today: ${coverageToday} of 3`;
        panelSub.textContent = `Logs this week: ${weeklyCount}`;
      } else {
        mainContainer.classList.add("duty");
        mainContainer.classList.remove("competitive");
        panelTitle.textContent = "ü§ù RESPONSIBILITY (COMMUNITY)";
        panelValue.textContent = `Categories today: ${coverageToday} of 3`;
        panelSub.textContent = `Logs this week: ${weeklyCount}`;
      }
    }

    // =========================
    // 8) RENDER CONTEXT (STRENGTHENED MANIPULATION)
    // =========================
    function renderContext(condition) {
      const pill = document.getElementById("contextPill");
      const text = document.getElementById("contextText");
      const mainContainer = document.getElementById("mainContainer");

      pill.style.display = "inline-flex";

      if (condition === "competitive") {
        pill.className = "context-pill context-competitive";
        pill.innerHTML = "üèÜ HIGH STANDARDS (PERSONAL)";
        text.innerHTML = `This study version highlights <strong>high personal standards</strong> and striving for excellent performance in your sustainable actions.<br><br>
        <em>Aim to meet your highest standard across the three categories (max one per category per day).</em>`;
        mainContainer.classList.add("competitive");
        mainContainer.classList.remove("duty");
      } else {
        pill.className = "context-pill context-duty";
        pill.innerHTML = "ü§ù RESPONSIBILITY (COMMUNITY)";
        text.innerHTML = `This study version highlights <strong>responsibility and doing your part for the community</strong> through sustainable actions.<br><br>
        <em>Do what you should do across the three categories (max one per category per day).</em>`;
        mainContainer.classList.add("duty");
        mainContainer.classList.remove("competitive");
      }
    }

    // =========================
    // 9) BOOT STUDY
    // =========================
    async function bootStudy() {
      Study.pid = getParam("pid");
      if (!Study.pid) {
        showNotification("Missing participant id. Open the link with ?pid=SA0001", "err");
        document.getElementById("contextText").textContent = "Missing participant id (pid).";
        return;
      }
      document.getElementById("pidLine").textContent = `Participant: ${Study.pid}`;

      const cred = await signInAnonymously(auth);
      Study.uid = cred.user.uid;

      const regRef = doc(db, "pid_registry", Study.pid);
      const regSnap = await getDoc(regRef);
      if (!regSnap.exists()) {
        showNotification("Invalid PID. Please use the exact study link you were given.", "err");
        document.getElementById("contextText").textContent = "Invalid PID (not found in registry).";
        return;
      }
      const reg = regSnap.data();
      const condition = reg?.condition;

      if (condition !== "competitive" && condition !== "duty") {
        showNotification("PID registry misconfigured. Contact the study team.", "err");
        document.getElementById("contextText").textContent = "Registry entry missing/invalid condition.";
        return;
      }

      const pRef = doc(db, "participants", Study.pid);
      const pSnap = await getDoc(pRef);

      if (!pSnap.exists()) {
        await setDoc(pRef, {
          uid: Study.uid,
          condition,
          createdAt: serverTimestamp()
        });
      } else {
        const pdata = pSnap.data();
        if (pdata?.uid && pdata.uid !== Study.uid) {
          showNotification("This PID has already been used on another device. Contact the study team.", "err");
          document.getElementById("contextText").textContent = "PID already claimed on another device.";
          return;
        }
        if (pdata?.condition !== condition) {
          showNotification("Condition mismatch detected. Contact the study team.", "err");
          document.getElementById("contextText").textContent = "Registry/participant mismatch.";
          return;
        }
      }

      Study.condition = condition;
      renderContext(Study.condition);
      renderHabits();
      wireLogButton();
      await refreshUIFromServer();

      setTimeout(checkManipulationTiming, 2500);
    }

    // =========================
    // 10) LOGGING
    // =========================
    async function logSelectedHabit() {
      if (!selectedHabitId) {
        showNotification("Select an action first.", "warn");
        return;
      }
      const habit = habits.find(h => h.id === selectedHabitId);
      if (!habit) {
        showNotification("Invalid selection.", "err");
        return;
      }

      const dayKey = localDayKey(new Date());
      const logId = `${dayKey}_${habit.category}`; // 1 per category per day
      const logRef = doc(db, "participants", Study.pid, "logs", logId);

      const existing = await getDoc(logRef);
      if (existing.exists()) {
        showNotification(`Already logged one ${prettyCategory(habit.category)} action today.`, "warn");
        return;
      }

      await setDoc(logRef, {
        habitId: habit.id,
        category: habit.category,
        dayKey,
        clientISO: new Date().toISOString(),
        serverTime: serverTimestamp()
      });

      trackLoggingBehavior(habit);
      showNotification(getContextualMessage(Study.condition), "ok", Study.condition);

      await refreshUIFromServer();
    }

    function wireLogButton() {
      const btn = document.getElementById("logButton");
      btn.addEventListener("click", async () => {
        btn.disabled = true;
        try {
          await logSelectedHabit();
        } catch (e) {
          showNotification(e?.message || "Could not log action.", "err");
        } finally {
          btn.disabled = false;
        }
      });
    }

    // =========================
    // 11) REFRESH UI
    // =========================
    async function refreshUIFromServer() {
      const pRef = doc(db, "participants", Study.pid);
      const pSnap = await getDoc(pRef);
      if (!pSnap.exists()) return;
      const pdata = pSnap.data();

      Study.createdAtDate = pdata?.createdAt?.toDate ? pdata.createdAt.toDate() : (Study.createdAtDate || new Date());

      let week = 1;
      if (Study.createdAtDate) {
        week = computeWeekFromServerCreatedAt(Study.createdAtDate);
      }
      document.getElementById("weekDisplay").textContent = `Week ${week} of 8`;
      document.getElementById("progressFill").style.width = `${(week / 8) * 100}%`;

      const logsCol = collection(db, "participants", Study.pid, "logs");
      const allSnap = await getDocs(query(logsCol, orderBy("dayKey", "desc")));
      const allLogs = [];
      allSnap.forEach(d => allLogs.push(d.data()));

      Study.totalLogs = allLogs.length;
      document.getElementById("totalLogs").textContent = String(Study.totalLogs);

      const days = new Set(allLogs.map(x => x.dayKey).filter(Boolean));
      document.getElementById("activeDays").textContent = String(days.size);

      let streak = 0;
      const cursor = new Date();
      cursor.setHours(0,0,0,0);
      while (true) {
        const k = localDayKey(cursor);
        if (days.has(k)) {
          streak += 1;
          cursor.setDate(cursor.getDate() - 1);
        } else break;
      }
      document.getElementById("streakDays").textContent = String(streak);

      const recentQ = query(logsCol, orderBy("serverTime", "desc"), limit(10));
      const recentSnap = await getDocs(recentQ);
      const recent = [];
      recentSnap.forEach(d => recent.push(d.data()));
      renderHistory(recent);

      await updateContextPanelFromSelf(allLogs);
    }

    function renderHistory(logs) {
      const historyList = document.getElementById("historyList");
      if (!logs || logs.length === 0) {
        historyList.innerHTML = `<div class="empty-state">No logs yet. Select an action you completed today and log it.</div>`;
        return;
      }

      historyList.innerHTML = "";
      logs.forEach(x => {
        const habit = habits.find(h => h.id === x.habitId);
        const item = document.createElement("div");
        item.className = "history-item";
        item.innerHTML = `
          <div class="history-emoji">${habit?.emoji || "üå±"}</div>
          <div class="history-details">
            <div class="history-name">${habit?.name || "Action"}</div>
            <div class="history-time">${x.dayKey || ""}</div>
            <div class="history-tag">${prettyCategory(x.category || "")}</div>
          </div>
        `;
        historyList.appendChild(item);
      });
    }

    // ============================================
    // MANIPULATION CHECK & BEHAVIOURAL TRACKING
    // ============================================
    function trackBehavioralIndicator(type, value) {
      const behaviorRef = doc(collection(db, "participants", Study.pid, "behavior"));
      const behavioralData = {
        timestamp: new Date().toISOString(),
        type,
        value,
        dayKey: localDayKey()
      };
      setDoc(behaviorRef, behavioralData).catch(() => {});
    }

    async function checkManipulationTiming() {
      if (!Study.pid) return;

      try {
        const logsCol = collection(db, "participants", Study.pid, "logs");
        const allSnap = await getDocs(query(logsCol, orderBy("dayKey", "desc")));
        const days = new Set();
        allSnap.forEach(d => {
          const v = d.data();
          if (v?.dayKey) days.add(v.dayKey);
        });

        const activeDays = days.size;
        const checkRef = doc(db, "participants", Study.pid, "checks", "manipulation");
        const checkSnap = await getDoc(checkRef);

        if (activeDays >= 3 && !checkSnap.exists()) {
          setTimeout(() => showManipulationCheckModal(), 800);
        }
      } catch (e) {
        console.log("Check timing error:", e);
      }
    }

    function showManipulationCheckModal() {
      const modal = document.createElement('div');
      modal.id = 'manipulationModal';
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.7);
        display: flex; align-items: center; justify-content: center;
        z-index: 2000; padding: 20px;
      `;

      modal.innerHTML = `
        <div style="
          background: white; border-radius: 24px; max-width: 450px; width: 100%;
          padding: 25px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        ">
          <h3 style="color: #004d40; margin-bottom: 10px; font-size: 22px;">ü§î Quick Check-in</h3>
          <p style="color: #5e7a6b; margin-bottom: 18px;">Please answer 3 short questions about your experience.</p>

          <div style="margin-bottom: 18px;">
            <p style="font-weight: 900; color: #004d40; margin-bottom: 10px;">1. Which statement best describes what you think this study emphasizes?</p>
            <label style="display:block; margin-bottom:8px;">
              <input type="radio" name="focus" value="standards" style="margin-right:8px;">
              <span>üèÜ Meeting high personal standards in my actions</span>
            </label>
            <label style="display:block; margin-bottom:8px;">
              <input type="radio" name="focus" value="responsibility" style="margin-right:8px;">
              <span>ü§ù Doing my part / responsibility to the community or environment</span>
            </label>
            <label style="display:block; margin-bottom:8px;">
              <input type="radio" name="focus" value="tracking" style="margin-right:8px;">
              <span>üìä Just tracking my habits (no specific emphasis)</span>
            </label>
            <label style="display:block;">
              <input type="radio" name="focus" value="unsure" style="margin-right:8px;">
              <span>‚ùì Not sure / didn't notice</span>
            </label>
          </div>

          <div style="margin-bottom: 18px;">
            <p style="font-weight: 900; color: #004d40; margin-bottom: 10px;">2. While using the tracker, how often did you think about meeting high personal standards in your actions?</p>
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
              <span style="font-size:12px;">Never</span>
              <span style="font-size:12px;">Sometimes</span>
              <span style="font-size:12px;">Constantly</span>
            </div>
            <input type="range" id="standardsScale" min="1" max="7" value="4" style="width:100%;">
            <div style="text-align:center; margin-top:5px;">
              <span id="standardsValue" style="font-weight:900; color:#004d40;">4</span>/7
            </div>
          </div>

          <div style="margin-bottom: 18px;">
            <p style="font-weight: 900; color: #004d40; margin-bottom: 10px;">3. While using the tracker, how often did you feel a sense of responsibility to do your part for the community/environment?</p>
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
              <span style="font-size:12px;">Never</span>
              <span style="font-size:12px;">Sometimes</span>
              <span style="font-size:12px;">Constantly</span>
            </div>
            <input type="range" id="communityScale" min="1" max="7" value="4" style="width:100%;">
            <div style="text-align:center; margin-top:5px;">
              <span id="communityValue" style="font-weight:900; color:#004d40;">4</span>/7
            </div>
          </div>

          <button id="submitMC" style="
            background:#004d40; color:white; border:none; padding:14px;
            border-radius:12px; width:100%; font-size:16px; font-weight:900; cursor:pointer;
          ">Submit</button>

          <p style="text-align:center; margin-top:12px; font-size:12px; color:#999;">
            Your responses help ensure the quality of our research.
          </p>
        </div>
      `;

      document.body.appendChild(modal);

      document.getElementById('standardsScale').addEventListener('input', (e) => {
        document.getElementById('standardsValue').textContent = e.target.value;
      });
      document.getElementById('communityScale').addEventListener('input', (e) => {
        document.getElementById('communityValue').textContent = e.target.value;
      });

      document.getElementById('submitMC').addEventListener('click', submitManipulationCheck);
    }

    async function submitManipulationCheck() {
      const focus = document.querySelector('input[name="focus"]:checked')?.value;
      const standardsScale = Number(document.getElementById('standardsScale').value);
      const communityScale = Number(document.getElementById('communityScale').value);

      if (!focus) {
        alert('Please answer question 1');
        return;
      }

      try {
        const checkRef = doc(db, "participants", Study.pid, "checks", "manipulation");
        await setDoc(checkRef, {
          focus,
          standardsScale,
          communityScale,
          condition: Study.condition,
          completedAtISO: new Date().toISOString(),
          dayKey: localDayKey()
        });

        trackBehavioralIndicator('manipulation_check_completed', 1);

        document.getElementById('manipulationModal').remove();
        showNotification('‚úÖ Thank you for your feedback!', 'ok', Study.condition);

      } catch (e) {
        showNotification('Error saving responses.', 'err', Study.condition);
      }
    }

    function trackLoggingBehavior(habit) {
      const hour = new Date().getHours();
      trackBehavioralIndicator('log_time_hour', hour);
      trackBehavioralIndicator('category_logged', habit.category);
      trackBehavioralIndicator('habit_id_logged', habit.id);
    }

    // =========================
    // START
    // =========================
    bootStudy().catch(err => {
      showNotification(err?.message || "Failed to start study.", "err");
      document.getElementById("contextText").textContent = err?.message || "Failed to start study.";
    });
  </script>
</body>
</html>
